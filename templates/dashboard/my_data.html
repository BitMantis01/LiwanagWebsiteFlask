{% extends "dashboard/base.html" %}

{% block content %}
<div class="data-content">
    <!-- Header Section -->
    <div class="content-header">
        <div class="header-info">
            <h1>My Data</h1>
            <p>Real-time measurement tracking and analysis</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" id="exportBtn">
                <i class="fas fa-download"></i>
                Export Data
            </button>
            <button class="btn btn-primary" onclick="location.reload()">
                <i class="fas fa-sync"></i>
                Refresh
            </button>
        </div>
    </div>

    <!-- Real-time Status Cards -->
    <div class="status-grid">
        <div class="status-card">
            <div class="status-icon vpt">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="status-info">
                <h3>VPT Status</h3>
                <div class="status-value" id="vptStatus">Normal</div>
                <div class="status-time" id="vptTime">Live</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon temp">
                <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="status-info">
                <h3>Temperature</h3>
                <div class="status-value" id="tempStatus">36.5°C</div>
                <div class="status-time" id="tempTime">Live</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon spo2">
                <i class="fas fa-heart"></i>
            </div>
            <div class="status-info">
                <h3>SpO2</h3>
                <div class="status-value" id="spo2Status">98%</div>
                <div class="status-time" id="spo2Time">Live</div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-icon total">
                <i class="fas fa-list-ol"></i>
            </div>
            <div class="status-info">
                <h3>Total Measurements</h3>
                <div class="status-value">{{ measurements|length }}</div>
                <div class="status-time">All time</div>
            </div>
        </div>
    </div>

    <!-- Detailed Measurements Table -->
    <div class="measurements-section primary-section">
        <div class="section-header">
            <h3>
                <i class="fas fa-table"></i>
                Detailed Measurements
            </h3>
            <div class="section-actions">
                <button class="btn btn-outline btn-sm" id="toggleGraphs">
                    <i class="fas fa-chart-line"></i>
                    <span id="graphToggleText">Show Graphs</span>
                </button>
                <button class="btn btn-outline btn-sm" onclick="loadRecentMeasurements()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- Table Controls -->
        <div class="table-controls">
            <div class="control-group">
                <label for="pointFilter">Filter by Point:</label>
                <select id="pointFilter" class="form-select">
                    <option value="">All Points</option>
                    <option value="Right Heel">Right Heel</option>
                    <option value="Right In Step">Right In Step</option>
                    <option value="Right 5th MT">Right 5th MT</option>
                    <option value="Right 3rd MT">Right 3rd MT</option>
                    <option value="Right 1st MT">Right 1st MT</option>
                    <option value="Right Big Toe">Right Big Toe</option>
                    <option value="Left Heel">Left Heel</option>
                    <option value="Left In Step">Left In Step</option>
                    <option value="Left 5th MT">Left 5th MT</option>
                    <option value="Left 3rd MT">Left 3rd MT</option>
                    <option value="Left 1st MT">Left 1st MT</option>
                    <option value="Left Big Toe">Left Big Toe</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="dateFilter">Date Range:</label>
                <select id="dateFilter" class="form-select">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="quarter">Last 3 Months</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="sortBy">Sort By:</label>
                <select id="sortBy" class="form-select">
                    <option value="date_desc" selected>Date (Newest)</option>
                    <option value="date_asc">Date (Oldest)</option>
                    <option value="point">Point Name</option>
                    <option value="vpt_desc">VPT (High to Low)</option>
                    <option value="vpt_asc">VPT (Low to High)</option>
                </select>
            </div>
        </div>
        
        <!-- Separate Tables for Left and Right Foot -->
        <div class="foot-tables-container">
            <!-- Left Foot Measurements -->
            <div class="foot-table-section">
                <div class="table-header">
                    <h3><i class="fas fa-foot"></i> Left Foot Measurements</h3>
                    <div class="table-stats">
                        <span class="count-badge" id="leftFootCount">Loading...</span>
                    </div>
                </div>
                <div class="table-container">
                    <table class="measurements-table detailed-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Measurement Point</th>
                                <th>VPT Voltage (V)</th>
                                <th>Temperature (°C)</th>
                                <th>SpO2 (%)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leftFootTableBody">
                            {% for measurement in measurements %}
                                {% if "Left" in measurement.point_name %}
                                <tr data-point="{{ measurement.point_name }}" data-vpt="{{ measurement.vpt_voltage or 0 }}">
                                    <td class="time-cell">
                                        <div class="datetime-display">
                                            <div class="date">{{ convert_timezone(measurement.timestamp).strftime('%m/%d/%Y') }}</div>
                                            <div class="time">{{ convert_timezone(measurement.timestamp).strftime('%I:%M %p') }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="point-display">
                                            <span class="point-name">{{ measurement.point_name }}</span>
                                            <span class="point-foot">
                                                <i class="fas fa-arrow-left text-green"></i> Left
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if measurement.vpt_voltage %}
                                            <div class="vpt-display">
                                                <span class="vpt-value">{{ measurement.vpt_voltage }}</span>
                                                <span class="vpt-unit">V</span>
                                            </div>
                                        {% else %}
                                            <span class="no-data">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if measurement.temperature %}
                                            <div class="temp-display">
                                                <span class="temp-value">{{ measurement.temperature }}</span>
                                                <span class="temp-unit">°C</span>
                                            </div>
                                        {% else %}
                                            <span class="no-data">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if measurement.spo2 %}
                                            <div class="spo2-display">
                                                <span class="spo2-value">{{ measurement.spo2 }}</span>
                                                <span class="spo2-unit">%</span>
                                            </div>
                                        {% else %}
                                            <span class="no-data">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if measurement.vpt_voltage %}
                                            {% set vpt_val = measurement.vpt_voltage %}
                                            {% if vpt_val < 10 %}
                                                <span class="status-badge normal">Normal</span>
                                            {% elif vpt_val < 25 %}
                                                <span class="status-badge elevated">Elevated</span>
                                            {% else %}
                                                <span class="status-badge high">High Risk</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-badge unknown">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon" onclick="viewMeasurement({{ measurement.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn-icon delete" onclick="deleteMeasurement({{ measurement.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% set left_measurements = [] %}
                    {% for measurement in measurements %}
                        {% if measurement.point_name and "Left" in measurement.point_name %}
                            {% set _ = left_measurements.append(measurement) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if left_measurements|length == 0 %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-foot"></i>
                        </div>
                        <div class="empty-content">
                            <h3>No left foot measurements yet</h3>
                            <p>Start collecting measurements from the left foot points.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Foot Measurements -->
            <div class="foot-table-section">
                <div class="table-header">
                    <h3><i class="fas fa-foot" style="transform: scaleX(-1);"></i> Right Foot Measurements</h3>
                    <div class="table-stats">
                        <span class="count-badge" id="rightFootCount">Loading...</span>
                    </div>
                </div>
                <div class="table-container">
                    <table class="measurements-table detailed-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Measurement Point</th>
                                <th>VPT Voltage (V)</th>
                                <th>Temperature (°C)</th>
                                <th>SpO2 (%)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rightFootTableBody">
                            {% for measurement in measurements %}
                                {% if "Right" in measurement.point_name %}
                                <tr data-point="{{ measurement.point_name }}" data-vpt="{{ measurement.vpt_voltage or 0 }}">
                                    <td class="time-cell">
                                        <div class="datetime-display">
                                            <div class="date">{{ convert_timezone(measurement.timestamp).strftime('%m/%d/%Y') }}</div>
                                            <div class="time">{{ convert_timezone(measurement.timestamp).strftime('%I:%M %p') }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="point-display">
                                            <span class="point-name">{{ measurement.point_name }}</span>
                                            <span class="point-foot">
                                                <i class="fas fa-arrow-right text-blue"></i> Right
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if measurement.vpt_voltage %}
                                            <div class="vpt-display">
                                                <span class="vpt-value">{{ measurement.vpt_voltage }}</span>
                                                <span class="vpt-unit">V</span>
                                            </div>
                                        {% else %}
                                            <span class="no-data">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if measurement.temperature %}
                                            <div class="temp-display">
                                                <span class="temp-value">{{ measurement.temperature }}</span>
                                                <span class="temp-unit">°C</span>
                                            </div>
                                        {% else %}
                                            <span class="no-data">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if measurement.spo2 %}
                                            <div class="spo2-display">
                                                <span class="spo2-value">{{ measurement.spo2 }}</span>
                                                <span class="spo2-unit">%</span>
                                            </div>
                                        {% else %}
                                            <span class="no-data">--</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if measurement.vpt_voltage %}
                                            {% set vpt_val = measurement.vpt_voltage %}
                                            {% if vpt_val < 10 %}
                                                <span class="status-badge normal">Normal</span>
                                            {% elif vpt_val < 25 %}
                                                <span class="status-badge elevated">Elevated</span>
                                            {% else %}
                                                <span class="status-badge high">High Risk</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-badge unknown">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-icon" onclick="viewMeasurement({{ measurement.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn-icon delete" onclick="deleteMeasurement({{ measurement.id }})" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% set right_measurements = [] %}
                    {% for measurement in measurements %}
                        {% if measurement.point_name and "Right" in measurement.point_name %}
                            {% set _ = right_measurements.append(measurement) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if right_measurements|length == 0 %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-foot" style="transform: scaleX(-1);"></i>
                        </div>
                        <div class="empty-content">
                            <h3>No right foot measurements yet</h3>
                            <p>Start collecting measurements from the right foot points.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

    <!-- Summary Statistics Tables -->
    <div class="summary-tables">
        <div class="summary-table-container">
            <div class="section-header">
                <h3>
                    <i class="fas fa-chart-bar"></i>
                    VPT Summary by Point
                </h3>
            </div>
            <div class="table-container">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Measurement Point</th>
                            <th>Total</th>
                            <th>Average VPT</th>
                            <th>Min VPT</th>
                            <th>Max VPT</th>
                            <th>Latest</th>
                        </tr>
                    </thead>
                    <tbody id="vptSummaryBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="summary-table-container">
            <div class="section-header">
                <h3>
                    <i class="fas fa-thermometer-half"></i>
                    Temperature & SpO2 Summary
                </h3>
            </div>
            <div class="table-container">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Current</th>
                            <th>Average</th>
                            <th>Min</th>
                            <th>Max</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="temperatureSummaryRow">
                            <td><i class="fas fa-thermometer-half"></i> Temperature</td>
                            <td id="currentTemp">--</td>
                            <td id="avgTemp">--</td>
                            <td id="minTemp">--</td>
                            <td id="maxTemp">--</td>
                            <td id="tempStatus">--</td>
                        </tr>
                        <tr id="spo2SummaryRow">
                            <td><i class="fas fa-heart"></i> SpO2</td>
                            <td id="currentSpo2">--</td>
                            <td id="avgSpo2">--</td>
                            <td id="minSpo2">--</td>
                            <td id="maxSpo2">--</td>
                            <td id="spo2Status">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts Section (Hidden by default) -->
    <div class="charts-section" id="chartsSection" style="display: none;">
        <!-- VPT Charts -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>Right Foot VPT Measurements</h3>
                <div class="chart-controls">
                    <select id="rightTimeRange" class="form-select">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 3 months</option>
                    </select>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="rightFootChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3>Left Foot VPT Measurements</h3>
                <div class="chart-controls">
                    <select id="leftTimeRange" class="form-select">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 3 months</option>
                    </select>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="leftFootChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <!-- Vitals Charts -->
        <div class="chart-container chart-full-width">
            <div class="chart-header">
                <h3>Temperature & SpO2 Trends</h3>
                <div class="chart-controls">
                    <button class="chart-toggle active" data-chart="both">Both</button>
                    <button class="chart-toggle" data-chart="temp">Temperature</button>
                    <button class="chart-toggle" data-chart="spo2">SpO2</button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="vitalsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Measurements Table -->
    <div class="measurements-section">
        <div class="section-header">
            <h3>Recent Measurements</h3>
            <div class="section-actions">
                <button class="btn btn-outline btn-sm" onclick="loadRecentMeasurements()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        </div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global chart instances
let rightFootChart = null;
let leftFootChart = null;
let vitalsChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    loadInitialData();
});

function initializeCharts() {
    // Right Foot Chart
    const rightFootCtx = document.getElementById('rightFootChart').getContext('2d');
    rightFootChart = new Chart(rightFootCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Right Heel',
                data: [],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Right In Step',
                data: [],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Right 5th MT',
                data: [],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Right 3rd MT',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Right 1st MT',
                data: [],
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Right Big Toe',
                data: [],
                borderColor: '#f97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                spanGaps: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'VPT Voltage (V)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                }
            }
        }
    });

    // Left Foot Chart
    const leftFootCtx = document.getElementById('leftFootChart').getContext('2d');
    leftFootChart = new Chart(leftFootCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Left Heel',
                data: [],
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Left In Step',
                data: [],
                borderColor: '#d97706',
                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Left 5th MT',
                data: [],
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Left 3rd MT',
                data: [],
                borderColor: '#059669',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Left 1st MT',
                data: [],
                borderColor: '#7c3aed',
                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                tension: 0.4,
                spanGaps: true
            }, {
                label: 'Left Big Toe',
                data: [],
                borderColor: '#ea580c',
                backgroundColor: 'rgba(234, 88, 12, 0.1)',
                tension: 0.4,
                spanGaps: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'VPT Voltage (V)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                }
            }
        }
    });

    // Vitals Chart
    const vitalsCtx = document.getElementById('vitalsChart').getContext('2d');
    vitalsChart = new Chart(vitalsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (°C)',
                data: [],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
            }, {
                label: 'SpO2 (%)',
                data: [],
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Temperature (°C)'
                    },
                    min: 35,
                    max: 40
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'SpO2 (%)'
                    },
                    min: 90,
                    max: 100,
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Temperature & SpO2 Monitoring'
                }
            }
        }
    });
}

function setupEventListeners() {
    // Time range changes
    document.getElementById('rightTimeRange').addEventListener('change', function() {
        loadChartData();
    });
    
    document.getElementById('leftTimeRange').addEventListener('change', function() {
        loadChartData();
    });

    // Chart toggle buttons
    document.querySelectorAll('.chart-toggle').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.chart-toggle').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const chartType = this.dataset.chart;
            toggleVitalsChart(chartType);
        });
    });

    // Export button
    document.getElementById('exportBtn').addEventListener('click', function() {
        window.location.href = '/api/measurements/export';
    });
    
    // Table filtering
    setupTableFilters();
    
    // Chart toggle functionality
    const toggleChartBtn = document.getElementById('toggleCharts');
    if (toggleChartBtn) {
        toggleChartBtn.addEventListener('click', function() {
            const chartsSection = document.getElementById('chartsSection');
            const isHidden = chartsSection.style.display === 'none';
            chartsSection.style.display = isHidden ? 'block' : 'none';
            this.textContent = isHidden ? 'Hide Charts' : 'Show Charts';
        });
    }
}

function setupTableFilters() {
    const pointFilter = document.getElementById('pointFilter');
    const startDateFilter = document.getElementById('startDate');
    const endDateFilter = document.getElementById('endDate');
    const sortSelect = document.getElementById('sortMeasurements');
    
    if (pointFilter) {
        pointFilter.addEventListener('change', filterTable);
    }
    if (startDateFilter) {
        startDateFilter.addEventListener('change', filterTable);
    }
    if (endDateFilter) {
        endDateFilter.addEventListener('change', filterTable);
    }
    if (sortSelect) {
        sortSelect.addEventListener('change', sortTable);
    }
}

function filterTable() {
    const pointFilter = document.getElementById('pointFilter')?.value || '';
    const startDate = document.getElementById('startDate')?.value || '';
    const endDate = document.getElementById('endDate')?.value || '';
    
    // Filter both left and right foot tables
    filterFootTable('leftFootTableBody', pointFilter, startDate, endDate);
    filterFootTable('rightFootTableBody', pointFilter, startDate, endDate);
    
    // Update counts and summary tables after filtering
    updateMeasurementCounts();
    
    // Update counts after filtering
    updateMeasurementCounts();
}

function filterFootTable(tableBodyId, pointFilter, startDate, endDate) {
    const tableBody = document.getElementById(tableBodyId);
    if (!tableBody) return;
    
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const pointCell = row.cells[1]?.textContent || '';
        const dateCell = row.cells[0]?.textContent || '';
        
        // Parse date from cell
        const rowDate = parseDisplayDate(dateCell);
        
        let show = true;
        
        // Filter by point (if point filter is set and doesn't match)
        if (pointFilter && !pointCell.toLowerCase().includes(pointFilter.toLowerCase())) {
            show = false;
        }
        
        // Filter by date range
        if (startDate && rowDate && rowDate < new Date(startDate)) {
            show = false;
        }
        if (endDate && rowDate && rowDate > new Date(endDate + 'T23:59:59')) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function parseDisplayDate(dateStr) {
    // Parse date from table cell that has both date and time divs
    try {
        const dateDiv = dateStr.match(/\d{2}\/\d{2}\/\d{4}/);
        const timeDiv = dateStr.match(/\d{1,2}:\d{2}\s*(AM|PM)/i);
        
        if (!dateDiv || !timeDiv) return null;
        
        const datePart = dateDiv[0]; // MM/DD/YYYY
        const timePart = timeDiv[0]; // HH:MM AM/PM
        
        return new Date(datePart + ' ' + timePart);
    } catch (e) {
        return null;
    }
}

function sortTable() {
    const sortBy = document.getElementById('sortMeasurements')?.value || 'date_desc';
    
    // Sort both left and right foot tables
    sortFootTable('leftFootTableBody', sortBy);
    sortFootTable('rightFootTableBody', sortBy);
    
    // Update counts and summary tables after sorting
    updateMeasurementCounts();
    
    // Update counts after sorting
    updateMeasurementCounts();
}

function sortFootTable(tableBodyId, sortBy) {
    const tableBody = document.getElementById(tableBodyId);
    if (!tableBody) return;
    
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        switch (sortBy) {
            case 'date_asc':
                return parseDisplayDate(a.cells[0].textContent) - parseDisplayDate(b.cells[0].textContent);
            case 'date_desc':
                return parseDisplayDate(b.cells[0].textContent) - parseDisplayDate(a.cells[0].textContent);
            case 'point':
                return a.cells[1].textContent.localeCompare(b.cells[1].textContent);
            case 'vpt_high':
                const vptA = parseFloat(a.cells[2].querySelector('.vpt-value')?.textContent) || 0;
                const vptB = parseFloat(b.cells[2].querySelector('.vpt-value')?.textContent) || 0;
                return vptB - vptA;
            case 'vpt_low':
                const vptA2 = parseFloat(a.cells[2].querySelector('.vpt-value')?.textContent) || 0;
                const vptB2 = parseFloat(b.cells[2].querySelector('.vpt-value')?.textContent) || 0;
                return vptA2 - vptB2;
            default:
                return 0;
        }
    });
    
    // Re-append sorted rows
    rows.forEach(row => tableBody.appendChild(row));
}

function loadInitialData() {
    loadChartData();
    updateMeasurementCounts();
}

function updateMeasurementCounts() {
    // Count left foot measurements
    const leftFootRows = document.querySelectorAll('#leftFootTableBody tr');
    const leftCount = Array.from(leftFootRows).filter(row => 
        row.style.display !== 'none'
    ).length;
    
    // Count right foot measurements  
    const rightFootRows = document.querySelectorAll('#rightFootTableBody tr');
    const rightCount = Array.from(rightFootRows).filter(row => 
        row.style.display !== 'none'
    ).length;
    
    // Update the count badges
    const leftCountBadge = document.getElementById('leftFootCount');
    const rightCountBadge = document.getElementById('rightFootCount');
    
    if (leftCountBadge) {
        leftCountBadge.textContent = `${leftCount} measurements`;
    }
    
    if (rightCountBadge) {
        rightCountBadge.textContent = `${rightCount} measurements`;
    }
    
    // Update summary tables
    updateVPTSummary();
    updateVitalsSummary();
}

function updateVPTSummary() {
    const vptSummaryBody = document.getElementById('vptSummaryBody');
    if (!vptSummaryBody) return;
    
    // Collect VPT data by point
    const pointData = {};
    
    // Process all measurements from both tables
    const allRows = [
        ...document.querySelectorAll('#leftFootTableBody tr'),
        ...document.querySelectorAll('#rightFootTableBody tr')
    ];
    
    allRows.forEach(row => {
        if (row.style.display === 'none') return;
        
        const pointName = row.cells[1]?.querySelector('.point-name')?.textContent;
        const vptElement = row.cells[2]?.querySelector('.vpt-value');
        const vptValue = vptElement ? parseFloat(vptElement.textContent) : null;
        const datetime = row.cells[0]?.textContent;
        
        if (pointName && vptValue && !isNaN(vptValue)) {
            if (!pointData[pointName]) {
                pointData[pointName] = { values: [], latest: null, latestDate: null };
            }
            pointData[pointName].values.push(vptValue);
            
            // Track latest measurement
            const date = parseDisplayDate(datetime);
            if (!pointData[pointName].latestDate || date > pointData[pointName].latestDate) {
                pointData[pointName].latest = vptValue;
                pointData[pointName].latestDate = date;
            }
        }
    });
    
    // Generate summary table
    vptSummaryBody.innerHTML = '';
    Object.keys(pointData).sort().forEach(pointName => {
        const data = pointData[pointName];
        const values = data.values;
        const total = values.length;
        const average = values.reduce((a, b) => a + b, 0) / total;
        const min = Math.min(...values);
        const max = Math.max(...values);
        const latest = data.latest;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${pointName}</strong></td>
            <td><span class="count">${total}</span></td>
            <td>${average.toFixed(2)}V</td>
            <td>${min.toFixed(2)}V</td>
            <td>${max.toFixed(2)}V</td>
            <td><strong>${latest.toFixed(2)}V</strong></td>
        `;
        vptSummaryBody.appendChild(row);
    });
    
    // Add empty state if no data
    if (Object.keys(pointData).length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="6" style="text-align: center; color: #64748b; padding: 2rem;">No VPT measurements available</td>';
        vptSummaryBody.appendChild(row);
    }
}

function updateVitalsSummary() {
    // Collect temperature and SpO2 data
    let tempValues = [];
    let spo2Values = [];
    let latestTemp = null;
    let latestSpo2 = null;
    let latestDate = null;
    
    // Process both left and right foot measurements
    const allRows = [
        ...document.querySelectorAll('#leftFootTableBody tr'),
        ...document.querySelectorAll('#rightFootTableBody tr')
    ];
    
    allRows.forEach(row => {
        if (row.style.display === 'none') return;
        
        const tempElement = row.cells[3]?.querySelector('.temp-value');
        const spo2Element = row.cells[4]?.querySelector('.spo2-value');
        const tempValue = tempElement ? parseFloat(tempElement.textContent) : null;
        const spo2Value = spo2Element ? parseFloat(spo2Element.textContent) : null;
        const datetime = row.cells[0]?.textContent;
        const date = parseDisplayDate(datetime);
        
        if (tempValue && !isNaN(tempValue)) {
            tempValues.push(tempValue);
            if (!latestDate || date > latestDate) {
                latestTemp = tempValue;
                latestDate = date;
            }
        }
        
        if (spo2Value && !isNaN(spo2Value)) {
            spo2Values.push(spo2Value);
            if (!latestDate || date > latestDate) {
                latestSpo2 = spo2Value;
                latestDate = date;
            }
        }
    });
    
    // Update temperature row
    const tempRow = document.querySelector('#temperatureSummaryRow');
    if (tempRow && tempValues.length > 0) {
        const avg = tempValues.reduce((a, b) => a + b, 0) / tempValues.length;
        const min = Math.min(...tempValues);
        const max = Math.max(...tempValues);
        
        tempRow.cells[1].innerHTML = latestTemp ? `${latestTemp.toFixed(1)}°C` : '--';
        tempRow.cells[2].innerHTML = `${avg.toFixed(1)}°C`;
        tempRow.cells[3].innerHTML = `${min.toFixed(1)}°C`;
        tempRow.cells[4].innerHTML = `${max.toFixed(1)}°C`;
        
        // Status based on normal body temperature
        let status = 'normal';
        let statusText = 'Normal';
        if (latestTemp && latestTemp < 36.1) {
            status = 'low';
            statusText = 'Low';
        } else if (latestTemp && latestTemp > 37.2) {
            status = 'high';
            statusText = 'High';
        }
        
        tempRow.cells[5].innerHTML = `<span class="status-badge ${status}">${statusText}</span>`;
    } else if (tempRow) {
        tempRow.cells[1].innerHTML = '--';
        tempRow.cells[2].innerHTML = '--';
        tempRow.cells[3].innerHTML = '--';
        tempRow.cells[4].innerHTML = '--';
        tempRow.cells[5].innerHTML = '<span class="status-badge unknown">No Data</span>';
    }
    
    // Update SpO2 row
    const spo2Row = document.querySelector('#spo2SummaryRow');
    if (spo2Row && spo2Values.length > 0) {
        const avg = spo2Values.reduce((a, b) => a + b, 0) / spo2Values.length;
        const min = Math.min(...spo2Values);
        const max = Math.max(...spo2Values);
        
        spo2Row.cells[1].innerHTML = latestSpo2 ? `${latestSpo2}%` : '--';
        spo2Row.cells[2].innerHTML = `${avg.toFixed(1)}%`;
        spo2Row.cells[3].innerHTML = `${min}%`;
        spo2Row.cells[4].innerHTML = `${max}%`;
        
        // Status based on normal SpO2 levels
        let status = 'normal';
        let statusText = 'Normal';
        if (latestSpo2 && latestSpo2 < 90) {
            status = 'high';
            statusText = 'Critical';
        } else if (latestSpo2 && latestSpo2 < 95) {
            status = 'elevated';
            statusText = 'Low';
        }
        
        spo2Row.cells[5].innerHTML = `<span class="status-badge ${status}">${statusText}</span>`;
    } else if (spo2Row) {
        spo2Row.cells[1].innerHTML = '--';
        spo2Row.cells[2].innerHTML = '--';
        spo2Row.cells[3].innerHTML = '--';
        spo2Row.cells[4].innerHTML = '--';
        spo2Row.cells[5].innerHTML = '<span class="status-badge unknown">No Data</span>';
    }
}

function loadChartData() {
    const rightDays = document.getElementById('rightTimeRange').value;
    const leftDays = document.getElementById('leftTimeRange').value;
    
    // Load chart data from API
    fetch(`/api/chart-data?days=${Math.max(rightDays, leftDays)}`)
        .then(response => response.json())
        .then(data => {
            updateRightFootChart(data.rightFoot);
            updateLeftFootChart(data.leftFoot);
            updateVitalsChart(data.vitals);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            showNotification('Failed to load chart data', 'error');
        });
}

function updateRightFootChart(data) {
    if (!rightFootChart || !data) return;
    
    rightFootChart.data.labels = data.labels;
    rightFootChart.data.datasets[0].data = data.heel;
    rightFootChart.data.datasets[1].data = data.instep;
    rightFootChart.data.datasets[2].data = data.fifth_mt;
    rightFootChart.data.datasets[3].data = data.third_mt;
    rightFootChart.data.datasets[4].data = data.first_mt;
    rightFootChart.data.datasets[5].data = data.big_toe;
    rightFootChart.update('none');
}

function updateLeftFootChart(data) {
    if (!leftFootChart || !data) return;
    
    leftFootChart.data.labels = data.labels;
    leftFootChart.data.datasets[0].data = data.heel;
    leftFootChart.data.datasets[1].data = data.instep;
    leftFootChart.data.datasets[2].data = data.fifth_mt;
    leftFootChart.data.datasets[3].data = data.third_mt;
    leftFootChart.data.datasets[4].data = data.first_mt;
    leftFootChart.data.datasets[5].data = data.big_toe;
    leftFootChart.update('none');
}

function updateVitalsChart(data) {
    if (!vitalsChart || !data) return;
    
    vitalsChart.data.labels = data.labels;
    vitalsChart.data.datasets[0].data = data.temperature;
    vitalsChart.data.datasets[1].data = data.spo2;
    vitalsChart.update('none');
}

function toggleVitalsChart(type) {
    if (!vitalsChart) return;
    
    const tempDataset = vitalsChart.data.datasets[0];
    const spo2Dataset = vitalsChart.data.datasets[1];
    
    switch(type) {
        case 'temp':
            tempDataset.hidden = false;
            spo2Dataset.hidden = true;
            break;
        case 'spo2':
            tempDataset.hidden = true;
            spo2Dataset.hidden = false;
            break;
        case 'both':
        default:
            tempDataset.hidden = false;
            spo2Dataset.hidden = false;
            break;
    }
    
    vitalsChart.update('none');
}

function loadRecentMeasurements() {
    showNotification('Data refreshed', 'success');
    location.reload();
}

function viewMeasurement(id) {
    window.location.href = `/measurement/${id}`;
}

function deleteMeasurement(id) {
    if (confirm('Are you sure you want to delete this measurement?')) {
        fetch(`/api/measurements/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Measurement deleted', 'success');
                location.reload();
            } else {
                showNotification('Failed to delete measurement', 'error');
            }
        })
        .catch(error => {
            showNotification('Error deleting measurement', 'error');
        });
    }
}

function showNotification(message, type = 'info') {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>

<style>
.data-content {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--light-gray);
}

.header-info h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0 0 0.5rem 0;
}

.header-info p {
    color: var(--gray);
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.status-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--light-gray);
}

.status-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 1.2rem;
}

.status-icon.vpt {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.status-icon.temp {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.status-icon.spo2 {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.status-icon.total {
    background: linear-gradient(135deg, #10b981, #059669);
}

.status-info h3 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--gray);
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-dark);
    line-height: 1;
    margin-bottom: 0.25rem;
}

.status-time {
    font-size: 0.8rem;
    color: var(--light-gray);
}

.charts-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-container {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--light-gray);
    overflow: hidden;
}

.chart-container.chart-full-width {
    grid-column: 1 / -1;
}

.chart-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chart-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.form-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--light-gray);
    border-radius: 6px;
    font-size: 0.875rem;
    background: var(--white);
    color: var(--text-dark);
}

.chart-toggle {
    padding: 0.5rem 1rem;
    border: 1px solid var(--light-gray);
    background: var(--white);
    color: var(--gray);
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: var(--transition);
}

.chart-toggle.active,
.chart-toggle:hover {
    background: var(--primary-blue);
    color: var(--white);
    border-color: var(--primary-blue);
}

.chart-content {
    padding: 1.5rem;
    height: 300px;
}

.measurements-section {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--light-gray);
    overflow: hidden;
}

.section-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0;
}

.section-actions {
    display: flex;
    gap: 0.5rem;
}

.table-container {
    overflow-x: auto;
}

.measurements-table {
    width: 100%;
    border-collapse: collapse;
}

.measurements-table th,
.measurements-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--light-gray);
}

.measurements-table th {
    background: var(--light-background);
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.875rem;
}

.measurements-table td {
    font-size: 0.875rem;
    color: var(--gray);
}

.time-cell {
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--gray);
    min-width: 120px;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--light-background);
    color: var(--gray);
    border: none;
    cursor: pointer;
    transition: var(--transition);
}

.btn-icon:hover {
    background: var(--primary-blue);
    color: var(--white);
}

.btn-icon.delete:hover {
    background: var(--danger);
    color: var(--white);
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
}

.empty-icon {
    font-size: 3rem;
    color: var(--light-gray);
    margin-bottom: 1rem;
}

.empty-content h3 {
    font-size: 1.25rem;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.empty-content p {
    color: var(--gray);
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius);
    color: var(--white);
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

.notification-success {
    background: var(--success);
}

.notification-error {
    background: var(--danger);
}

.notification-info {
    background: var(--primary-blue);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
    white-space: nowrap;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: var(--white);
    box-shadow: var(--shadow);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
}

.btn-outline {
    background: transparent;
    color: var(--gray);
    border: 1px solid var(--light-gray);
}

.btn-outline:hover {
    background: var(--off-white);
    border-color: var(--primary-blue);
    color: var(--primary-blue);
}

@media (max-width: 1200px) {
    .charts-section {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .data-content {
        padding: 1rem;
    }
    
    .content-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .status-grid {
        grid-template-columns: 1fr;
    }
    
    .header-actions {
        justify-content: center;
    }
}
</style>
{% endblock %}
