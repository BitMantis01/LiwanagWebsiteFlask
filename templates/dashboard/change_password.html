{% extends "dashboard/base.html" %}

{% block page_title %}Change Password{% endblock %}

{% block content %}
<div class="password-content">
    <div class="password-container">
        <div class="password-card">
            <div class="card-header">
                <div class="header-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2>Change Password</h2>
                <p>Ensure your account is secure with a strong password</p>
            </div>
            
            <form method="POST" class="password-form" id="passwordForm">
                {{ form.hidden_tag() }}
                
                <div class="form-group">
                    {{ form.current_password.label(class="form-label") }}
                    <div class="password-input-wrapper">
                        {{ form.current_password(class="form-input password-input" + (" error" if form.current_password.errors else ""), id="currentPassword") }}
                        <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                            <i class="fas fa-eye" id="currentPasswordToggle"></i>
                        </button>
                    </div>
                    {% if form.current_password.errors %}
                        <div class="error-message">
                            {% for error in form.current_password.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    {{ form.new_password.label(class="form-label") }}
                    <div class="password-input-wrapper">
                        {{ form.new_password(class="form-input password-input" + (" error" if form.new_password.errors else ""), id="newPassword") }}
                        <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                            <i class="fas fa-eye" id="newPasswordToggle"></i>
                        </button>
                    </div>
                    {% if form.new_password.errors %}
                        <div class="error-message">
                            {% for error in form.new_password.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <!-- Password Strength Indicator -->
                    <div class="password-strength" id="passwordStrength">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <div class="strength-text" id="strengthText">Enter password</div>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="password-requirements">
                        <h4>Password must contain:</h4>
                        <ul id="passwordChecklist">
                            <li id="lengthCheck"><i class="fas fa-times"></i> At least 8 characters</li>
                            <li id="uppercaseCheck"><i class="fas fa-times"></i> One uppercase letter</li>
                            <li id="lowercaseCheck"><i class="fas fa-times"></i> One lowercase letter</li>
                            <li id="numberCheck"><i class="fas fa-times"></i> One number</li>
                            <li id="specialCheck"><i class="fas fa-times"></i> One special character</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group">
                    {{ form.confirm_password.label(class="form-label") }}
                    <div class="password-input-wrapper">
                        {{ form.confirm_password(class="form-input password-input" + (" error" if form.confirm_password.errors else ""), id="confirmPassword") }}
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                            <i class="fas fa-eye" id="confirmPasswordToggle"></i>
                        </button>
                    </div>
                    {% if form.confirm_password.errors %}
                        <div class="error-message">
                            {% for error in form.confirm_password.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="password-match" id="passwordMatch"></div>
                </div>
                
                <div class="form-actions">
                    {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                    <a href="{{ url_for('profile') }}" class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i>
                        Back to Profile
                    </a>
                </div>
            </form>
        </div>
        
        <!-- Security Tips -->
        <div class="security-tips">
            <div class="tips-header">
                <i class="fas fa-lightbulb"></i>
                <h3>Security Tips</h3>
            </div>
            <div class="tips-content">
                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="tip-text">
                        <h4>Use a Strong Password</h4>
                        <p>Create a unique password with a mix of letters, numbers, and symbols.</p>
                    </div>
                </div>
                
                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="tip-text">
                        <h4>Change Regularly</h4>
                        <p>Update your password every 3-6 months for better security.</p>
                    </div>
                </div>
                
                <div class="tip-item">
                    <div class="tip-icon">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <div class="tip-text">
                        <h4>Keep it Private</h4>
                        <p>Never share your password with others or save it in unsecured locations.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.password-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 1rem;
}

.password-container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
    align-items: start;
}

.password-card,
.security-tips {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--light-gray);
    overflow: hidden;
}

.card-header {
    padding: 2rem;
    text-align: center;
    background: linear-gradient(135deg, var(--off-white), rgba(96, 165, 250, 0.05));
    border-bottom: 1px solid var(--light-gray);
}

.header-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: var(--white);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
}

.card-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
}

.card-header p {
    color: var(--gray);
    font-size: 0.9rem;
    margin: 0;
}

.password-form {
    padding: 2rem;
}

.form-group {
    margin-bottom: 2rem;
}

.form-label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
    font-size: 0.875rem;
}

.password-input-wrapper {
    position: relative;
}

.form-input {
    width: 100%;
    padding: 0.75rem 3rem 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: var(--transition);
    background: var(--white);
}

.form-input:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input.error {
    border-color: var(--danger);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.password-toggle {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--gray);
    cursor: pointer;
    padding: 0.25rem;
    transition: var(--transition);
}

.password-toggle:hover {
    color: var(--primary-blue);
}

.password-strength {
    margin-top: 1rem;
}

.strength-bar {
    width: 100%;
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.strength-fill {
    height: 100%;
    transition: var(--transition);
    border-radius: 2px;
}

.strength-text {
    font-size: 0.8rem;
    font-weight: 500;
    text-align: center;
}

.password-requirements {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--off-white);
    border-radius: 8px;
    border: 1px solid var(--light-gray);
}

.password-requirements h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.75rem;
}

.password-requirements ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.password-requirements li {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
    font-size: 0.8rem;
    color: var(--gray);
    transition: var(--transition);
}

.password-requirements li i {
    width: 12px;
    font-size: 0.7rem;
}

.password-requirements li.valid {
    color: var(--success);
}

.password-requirements li.valid i {
    color: var(--success);
}

.password-match {
    margin-top: 0.5rem;
    font-size: 0.8rem;
    font-weight: 500;
}

.error-message {
    margin-top: 0.5rem;
    color: var(--danger);
    font-size: 0.75rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--light-gray);
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: var(--white);
    box-shadow: var(--shadow);
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-outline {
    background: transparent;
    color: var(--primary-blue);
    border: 2px solid var(--primary-blue);
}

.btn-outline:hover {
    background: var(--primary-blue);
    color: var(--white);
}

.security-tips {
    position: sticky;
    top: 2rem;
}

.tips-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--warning), #f59e0b);
    color: var(--white);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.tips-header h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
}

.tips-content {
    padding: 1.5rem;
}

.tip-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.tip-item:last-child {
    margin-bottom: 0;
}

.tip-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
    color: var(--white);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.tip-text h4 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.tip-text p {
    font-size: 0.8rem;
    color: var(--gray);
    margin: 0;
    line-height: 1.4;
}

@media (max-width: 768px) {
    .password-container {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .security-tips {
        position: static;
    }
}
</style>

<script>
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const toggle = document.getElementById(inputId + 'Toggle');
    
    if (input.type === 'password') {
        input.type = 'text';
        toggle.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        toggle.className = 'fas fa-eye';
    }
}

function checkPasswordStrength(password) {
    let score = 0;
    let feedback = '';
    
    // Length check
    if (password.length >= 8) score += 1;
    if (password.length >= 12) score += 1;
    
    // Character variety checks
    if (/[a-z]/.test(password)) score += 1;
    if (/[A-Z]/.test(password)) score += 1;
    if (/[0-9]/.test(password)) score += 1;
    if (/[^A-Za-z0-9]/.test(password)) score += 1;
    
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    if (password.length === 0) {
        strengthFill.style.width = '0%';
        strengthFill.style.background = '#e2e8f0';
        strengthText.textContent = 'Enter password';
        strengthText.style.color = '#64748b';
        return;
    }
    
    switch (true) {
        case score < 3:
            strengthFill.style.width = '25%';
            strengthFill.style.background = '#ef4444';
            strengthText.textContent = 'Weak';
            strengthText.style.color = '#ef4444';
            break;
        case score < 5:
            strengthFill.style.width = '50%';
            strengthFill.style.background = '#f59e0b';
            strengthText.textContent = 'Fair';
            strengthText.style.color = '#f59e0b';
            break;
        case score < 6:
            strengthFill.style.width = '75%';
            strengthFill.style.background = '#3b82f6';
            strengthText.textContent = 'Good';
            strengthText.style.color = '#3b82f6';
            break;
        default:
            strengthFill.style.width = '100%';
            strengthFill.style.background = '#10b981';
            strengthText.textContent = 'Strong';
            strengthText.style.color = '#10b981';
    }
}

function updatePasswordChecklist(password) {
    const checks = {
        lengthCheck: password.length >= 8,
        uppercaseCheck: /[A-Z]/.test(password),
        lowercaseCheck: /[a-z]/.test(password),
        numberCheck: /[0-9]/.test(password),
        specialCheck: /[^A-Za-z0-9]/.test(password)
    };
    
    Object.keys(checks).forEach(checkId => {
        const element = document.getElementById(checkId);
        const icon = element.querySelector('i');
        
        if (checks[checkId]) {
            element.classList.add('valid');
            icon.className = 'fas fa-check';
        } else {
            element.classList.remove('valid');
            icon.className = 'fas fa-times';
        }
    });
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const matchElement = document.getElementById('passwordMatch');
    
    if (confirmPassword.length === 0) {
        matchElement.textContent = '';
        return;
    }
    
    if (newPassword === confirmPassword) {
        matchElement.textContent = '✓ Passwords match';
        matchElement.style.color = '#10b981';
    } else {
        matchElement.textContent = '✗ Passwords do not match';
        matchElement.style.color = '#ef4444';
    }
}

function updateSubmitButton() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const submitBtn = document.getElementById('submitBtn');
    
    const isValid = newPassword.length >= 8 && 
                   /[A-Z]/.test(newPassword) && 
                   /[a-z]/.test(newPassword) && 
                   /[0-9]/.test(newPassword) && 
                   /[^A-Za-z0-9]/.test(newPassword) &&
                   newPassword === confirmPassword;
    
    submitBtn.disabled = !isValid;
}

document.addEventListener('DOMContentLoaded', function() {
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    newPasswordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        updatePasswordChecklist(this.value);
        checkPasswordMatch();
        updateSubmitButton();
    });
    
    confirmPasswordInput.addEventListener('input', function() {
        checkPasswordMatch();
        updateSubmitButton();
    });
    
    // Initial state
    updateSubmitButton();
});
</script>
{% endblock %}
